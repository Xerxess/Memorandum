<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [内存管理](#内存管理)
  - [循环引用](#循环引用)

<!-- /code_chunk_output -->

# 内存管理

- Godot 通过实现引用计数来释放某些不再使用的实例，而非通过垃圾收集器（GC），或者需要纯手动管理内存释放来实现这一操作。
- RefCounted 类（或继承该类的任何类，例如 Resource）的任何实例在不再使用时将自动释放。
- 对于非 RefCounted 类（例如 Node 或基本 Object 类型）的实例，这些实例将保留在内存中，直到使用 free() （或用于节点的 queue_free()）才会从内存中删除。
- 如果通过 free() 或 queue_free() 删除 Node，则它的所有子节点也将会被递归删除。
- 继承自 RefCounted 的类（未指定父类时会默认继承该类）的实例在不被使用时释放，
- 对于继承自 Object 的类则需要手动管理内存。

## 循环引用

- 避免造成无法释放的循环引用，Godot 提供了用于创建弱引用的 WeakRef 类，可以访问到对象，但是不会阻止 RefCounted 的释放。

```gdscript
extends Node

var my_file_ref

func _ready():
    var f = FileAccess.open("user://example_file.json", FileAccess.READ)
    my_file_ref = weakref(f)
    # FileAccess类继承了RefCounted，因此在不使用时会释放它

    # 当other_node完成时，WeakRef不会阻止f被释放
    other_node.use_file(f)

func _this_is_called_later():
    var my_file = my_file_ref.get_ref()
    if my_file:
        my_file.close()
```

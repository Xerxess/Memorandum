<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [类](#类)
  - [内部类（嵌套类）](#内部类嵌套类)
  - [类的属性](#类的属性)
  - [计算属性](#计算属性)
  - [类的方法](#类的方法)
  - [静态方法](#静态方法)
  - [继承](#继承)
  - [构造函数](#构造函数)
  - [静态构造函数](#静态构造函数)

<!-- /code_chunk_output -->

# 类

- 默认情况下，所有脚本文件都是未命名的类，这时只能使用文件的路径来引用这些无名类（相对路径或绝对路径）。
- 类（以文件形式保存）
- 每个 GDScript 文件都是一个隐含的类。
- extends 关键字定义了这个脚本所继承或扩展的类。

```gdscript
# 文件名: Player.gd

 # 定义类名，使其他脚本可以直接使用 Player 类型
class_name Player 

extends Node2D  # 继承自 Node2D

# 类属性
var name = "Hero"
var health = 100
var speed = 200

# 类方法
func take_damage(amount):
    health -= amount
    print(name + " 受到 " + str(amount) + " 点伤害")

func heal(amount):
    health = min(health + amount, 100)
    print(name + " 恢复 " + str(amount) + " 点生命值")
```

## 内部类（嵌套类）

```gdscript
# GameManager.gd
extends Node

# 内部类定义
class EnemyData:
    var type = ""
    var health = 100
    var damage = 10
    
    func _init(type_name, hp, dmg):
        type = type_name
        health = hp
        damage = dmg

class PlayerStats:
    var level = 1
    var experience = 0
    var skill_points = 0
    
    func gain_experience(amount):
        experience += amount
        if experience >= level * 100:
            level_up()
    
    func level_up():
        level += 1
        skill_points += 3
        print("升级到等级 " + str(level) + "!")

# 使用内部类
func create_enemy():
    var goblin = EnemyData.new("Goblin", 50, 8)
    var orc = EnemyData.new("Orc", 100, 15)
    return [goblin, orc]

func create_player():
    var stats = PlayerStats.new()
    return stats
```

## 类的属性

```gdscript
class_name Character

extends Node2D

# 公开属性（可以在编辑器中设置）
@export var character_name = "Hero"
@export var max_health = 100
@export_range(1, 100, 1) var level = 1

# 私有属性（以下划线开头）
var _current_health = 100
var _internal_state = {}

# 只读属性（只能通过方法访问）
var _experience = 0

func get_experience():
    return _experience

# 常量
const MAX_LEVEL = 100
const BASE_SPEED = 200

# 静态变量
static var total_characters = 0
```

## 计算属性

```gdscript
class_name HealthComponent

extends Node

var _health = 100:
    set(value):
        if value != _health:
            _health = clamp(value, 0, max_health)
            emit_signal("health_changed", _health)
            
            if _health <= 0:
                emit_signal("died")
    get:
        return _health

var max_health = 100:
    set(value):
        if value > 0 and value != max_health:
            max_health = value
            _health = min(_health, max_health)

signal health_changed(new_health)
signal died

```

## 类的方法

```gdscript
class_name Projectile

extends Area2D

var damage = 10
var speed = 500
var direction = Vector2.ZERO
var lifetime = 3.0

# 构造函数
func _init(damage_val = 10, speed_val = 500):
    damage = damage_val
    speed = speed_val

# 初始化函数（当节点添加到场景树时）
func _ready():
    connect("body_entered", self, "_on_body_entered")
    var timer = get_tree().create_timer(lifetime)
    timer.connect("timeout", self, "destroy")

# 析构函数（对象被销毁时）
func _exit_tree():
    print("Projectile destroyed")

func destroy():
    queue_free()

func _on_body_entered(body):
    if body.has_method("take_damage"):
        body.take_damage(damage)
    destroy()

```

## 静态方法

```gdscript
class_name MathUtils

extends Node

# 静态方法不需要实例化类
static func distance(point1: Vector2, point2: Vector2) -> float:
    return point1.distance_to(point2)

# 静态方法调用
var dist = MathUtils.distance(Vector2(0, 0), Vector2(3, 4))
```

## 继承

- 继承使用 extends 关键字
- 不允许多重继承

```gdscript
# 继承/扩展全局可用的类。
extends SomeClass

# 继承/扩展命名类文件。
extends "somefile.gd"

# 继承/扩展另一个文件中的内部类。
extends "somefile.gd".SomeInnerClass
```

## 构造函数

- 类的构造函数名为 _init，会在类进行初始化时调用 。

```gdscript
func _init(arg):
    super("some_default", arg)
```

## 静态构造函数

- 静态构造函数是名为 _static_init 的静态函数。

```gdscript
static var my_static_var = 1

static func _static_init():
    my_static_var = 2
```

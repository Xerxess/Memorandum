
  <!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->
  
  <!-- code_chunk_output -->
  
- [RabbitMQ 是什么](#rabbitmq-是什么)
  - [RabbitMQ 核心概念](#rabbitmq-核心概念)
  - [特性](#特性)
  - [使用场景](#使用场景)
  - [整体架构图](#整体架构图)
  - [Exchange](#exchange)
  - [消息流转过程](#消息流转过程)
  
  <!-- /code_chunk_output -->
  
# RabbitMQ 是什么
  
  RabbitMQ 是一个开源的消息代理中间件（Message Broker），实现了高级消息队列协议（AMQP）。它主要用于应用程序之间的异步通信、解耦和流量削峰。
  
## RabbitMQ 核心概念
  
- Producer(生产者)
  - 产生消息并发送到 RabbitMQ
  - 不关心消息如何路由和存储
- Exchange(交换机)
  - fanout 绑定到该交换机的所有队列都会收到消息（广播）
  - direct 根据 routing_key 精确匹配（点对点）
  - topic 根据通配符匹配（灵活）
    - *.order.#
    - logs.*
  - headers 根据消息头属性匹配
- Binding（绑定）
  - 连接 Exchange 和 Queue 的桥梁
  - 定义 routing_key 规则
- Queue(队列)
  - 消息存储的容器（FIFO 先进先出）
  - 可以设置持久化、长度限制、消息过期等属性  
  - 多个消费者可以订阅同一个队列（竞争消费
- Consumer(消费者)
  - 从队列中获取并处理消息
  - 可以是多个消费者共享一个队列
- Virtual Host（虚拟主机）
  - 隔离不同应用/环境
  - 独立用户、权限、队列
  
## 特性
  
- 持久化 消息和队列可以持久化到磁盘，服务器重启后不丢失
- 确认机制 支持 ACK 确认，确保消息被正确处理
- 死信队列 无法消费的消息进入死信队列，便于排查
- 优先级队列 消息可以设置优先级
- 延迟队列 消息延迟指定时间后消费
- 集群 支持多节点集群，提供高可用和负载均衡
- 镜像队列 队列主从复制，避免单点故障
  
## 使用场景
  
- 不适合海量日志场景
- 异步处理 订单创建后，异步发送邮件、短信通知
- 系统解耦 支付系统与订单系统通过消息队列解耦
- 流量削峰 秒杀场景，缓冲高并发请求
- 分布式事务
- 任务队列 异步执行耗时任务
  
## 整体架构图
  
  ```mermaid
  graph LR
      subgraph Producer[生产者]
          P[Producer]
      end
      
      subgraph RabbitMQ[RabbitMQ Server]
          subgraph VHOST[Virtual Host]
              subgraph Exchange[交换机层]
                  E[Exchange<br/>fanout/direct/topic/headers]
              end
              
              subgraph Binding[绑定层]
                  B[Binding]
              end
              
              subgraph Queue[队列层]
                  Q1[Queue A]
                  Q2[Queue B]
                  Q3[Queue C]
              end
          end
      end
      
      subgraph Consumer[消费者]
          C1[Consumer 1]
          C2[Consumer 2]
          C3[Consumer 3]
      end
      
      P -->|"Publish Message<br/>routing_key"| E
      E -->|"Route"| B
      B --> Q1
      B --> Q2
      B --> Q3
      Q1 --> C1
      Q2 --> C2
      Q3 --> C3
  ```
  
## Exchange
  
  ```mermaid
  graph LR
      subgraph Fanout["fanout (广播)"]
          F[Exchange] --> FA[Queue A]
          F --> FB[Queue B]
          F --> FC[Queue C]
      end
      
      subgraph Direct["direct (直接)"]
          D[Exchange<br/>routing_key=order] --> DA[Queue A]
      end
      
      subgraph Topic["topic (主题)"]
          T[Exchange<br/>topic] -->|"*.order.#"| TA[Queue A]
          T -->|"logs.*"| TB[Queue B]
          T -->|"#"| TC[Queue C]
      end
      
      subgraph Headers["headers (头部)"]
          H[Exchange<br/>headers] --> HA[Queue]
      end
  ```
  
## 消息流转过程
  
  ```text
  ┌──────────────────────────────────────────────────────────────────────────────────┐
  │                           消息发布流程                                             │
  └──────────────────────────────────────────────────────────────────────────────────┘
  
     Producer                    RabbitMQ                                              Consumer
        │                           │                                                    │
        │   ┌─────────────────┐     │                                                    │
        │   │  1. 建立连接     │     │                                                    │
        │   └────────┬────────┘     │                                                    │
        │            │              │                                                    │
        │   ┌────────▼────────┐     │                                                    │
        │   │  2. 创建通道     │     │                                                    │
        │   │  Channel        │     │                                                    │
        │   └────────┬────────┘     │                                                    │
        │            │              │                                                    │
        │            ▼              │                                                    │
        │   ┌─────────────────┐     │                                                    │
        │   │  3. 发送消息     │     │                                                    │
        │   │  Publish        │────►│  4. Exchange 根据类型和 Binding 路由消息            │
        │   │  (带 routing_key)│     │                                                    │
        │   └─────────────────┘     │                                                    │
        │                           ▼                                                    │
        │                   ┌───────────────┐                                           │
        │                   │    Queue      │◄─────────────────── 5. 消息存入队列         │
        │                   │  (消息持久化)  │                                            │
        │                   └───────────────┘                                           │
        │                           │                                                    │
        │                           │              6. Consumer 订阅队列                   │
        │                           │◄─────────────────────────────────────┐              │
        │                           │                                      │              │
        │                           │    7. 推送消息给 Consumer             │              │
        │                           ├──────────────────────────────────────┤              │
        │                           │                                      │              │
        ▼                           ▼                                      ▼              ▼
  
  ```
  
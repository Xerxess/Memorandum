<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [HAProxy](#haproxy)
  - [核心概念](#核心概念)
  - [4 层 (TCP) 与 7 层 (HTTP) 的区别](#4-层-tcp-与-7-层-http-的区别)
  - [常用负载均衡算法](#常用负载均衡算法)
  - [HTTP 负载均衡 示例](#http-负载均衡-示例)

<!-- /code_chunk_output -->

# HAProxy

HAProxy (High Availability Proxy) 是一款免费、开源、高性能的负载均衡器和代理软件。它主要用于在多个服务器之间分发网络流量，从而提高网站和应用的性能和可靠性。

<https://www.haproxy.org/>

## 核心概念

- ACL (Access Control List): 访问控制列表。用来判断流量是否符合某些条件（比如：如果是 /api 开头的请求，转发给后端 A）。
- Backend (后端): 服务器池。这里定义了具体处理请求的一组真实服务器列表。
- Frontend (前端): 入口监听。这里定义了 HAProxy 监听哪个端口（如 80 或 443），并根据 ACL 规则将流量转发给哪个 Backend。

## 4 层 (TCP) 与 7 层 (HTTP) 的区别

- Mode HTTP (7 层)
  - HAProxy 会解析 HTTP 协议头
  - 可以根据 URL 路径 (/api)、域名、Cookie 进行路由
  - 用于 Web 服务器
- Mode TCP (4 层):
  - HAProxy 不解析内容，只转发 TCP 数据包
  - 性能略高
  - 用于数据库负载均衡、MySQL、Redis、SSH 等

## 常用负载均衡算法

- 使用 balance 指令设置算法
  - roundrobin: 轮询。最常用，依次分配。
  - leastconn: 最少连接。将请求发给当前连接数最少的服务器（适合长连接，如数据库）。
  - source: 源地址哈希。根据客户端 IP 进行哈希，保证同一个 IP 的用户总是打到同一台服务器（解决 Session 问题，但可能导致负载不均）。

## HTTP 负载均衡 示例

```text
# ---------------------------------
# GLOBAL (全局设置)
# ---------------------------------
global
    # 以守护进程模式运行
    daemon
    # 运行用户
    user haproxy
    group haproxy
    # 记录日志到本地系统日志 (通过 rsyslot 转发)
    log /dev/log local0
    log /dev/log local1 notice

# ---------------------------------
# DEFAULTS (默认设置)
# ---------------------------------
defaults
    # 模式：http (第7层) 或 tcp (第4层)
    mode http
    # 开启日志统计
    log global
    # 使用 HTTP 日志格式
    option httplog
    # 如果后端挂了，不排队等待，直接返回错误
    option dontlognull
    # 连接超时 (毫秒)
    timeout connect 5000
    # 客户端超时
    timeout client  50000
    # 服务器超时
    timeout server  50000
    # 开启健康检查页面统计
    stats enable

# ---------------------------------
# FRONTEND (前端/入口)
# ---------------------------------
frontend my_website_front
    # 监听本机 80 端口
    bind *:80
    # 定义默认后端
    default_backend my_web_servers
    # (可选) ACL 示例：如果是 /api 开头，转到 api_servers
    # acl is_api path_beg /api
    # use_backend api_servers if is_api

# ---------------------------------
# BACKEND (后端/服务器池)
# ---------------------------------
backend my_web_servers
    # 负载均衡算法：roundrobin (轮询)
    balance roundrobin
    
    # 定义健康检查：每隔 2000ms 检查一次，如果 2 次失败认为 down，3 次成功认为 up
    option httpchk GET /health
    
    # 服务器列表 (名字 IP:端口 参数)
    # check 表示启用健康检查
    server web1 192.168.1.10:80 check inter 2000 fall 2 rise 3
    server web2 192.168.1.11:80 check inter 2000 fall 2 rise 3
    # 备用服务器，只有当 web1 和 web2 都挂了才启用
    server web_backup 192.168.1.12:80 check backup

# ---------------------------------
# STATISTICS (监控页面)
# ---------------------------------
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:password  # 设置监控页面密码

```

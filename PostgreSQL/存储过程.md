
# 存储过程

存储过程（Stored Procedures）是存储在数据库中的一组 SQL 语句和逻辑。

- 如果你需要计算并返回一个值给程序，用 FUNCTION。
- 如果你需要执行一系列涉及多个步骤的操作，尤其是需要中途提交事务，用 PROCEDURE。

## CREATE PROCEDURE

```sql
-- 创建存储过程
CREATE OR REPLACE PROCEDURE transfer_funds(
    sender_id int,
    receiver_id int,
    amount numeric
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- 减少发送者余额
    UPDATE accounts SET balance = balance - amount WHERE id = sender_id;
    
    -- 增加接收者余额
    UPDATE accounts SET balance = balance + amount WHERE id = receiver_id;

    -- 在 2025 年的 PG 版本中，过程中可以手动提交事务
    COMMIT; 
END;
$$;

-- 调用存储过程
CALL transfer_funds(1, 2, 500.00);
```

## 存储过程 (PROCEDURE) vs 函数 (FUNCTION)

特性| 存储过程 (PROCEDURE)| 函数 (FUNCTION)
-|-|-
调用方式| CALL procedure_name() |SELECT function_name()
事务支持| 支持 COMMIT / ROLLBACK |不支持（随外部 SQL 自动成功或回滚）
返回值| 没有直接返回值（只能通过 INOUT 参数） |必须有返回值（如 RETURN int 或 SETOF）
使用场景| 执行批处理、数据迁移、需要手动控制事务的逻辑 |计算数值、数据转换、在 SELECT 语句中调用

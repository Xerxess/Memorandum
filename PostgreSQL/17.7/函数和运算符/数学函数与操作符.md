<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [PostgreSQL 17.7 数学函数与操作符完整文档](#postgresql-177-数学函数与操作符完整文档)
  - [概述](#概述)
    - [功能特点](#功能特点)
  - [1. 数学操作符](#1-数学操作符)
    - [基础算术操作符](#基础算术操作符)
    - [特殊操作符](#特殊操作符)
    - [位操作符（整数类型）](#位操作符整数类型)
  - [2. 数学函数](#2-数学函数)
    - [基础数学函数](#基础数学函数)
    - [取整函数](#取整函数)
    - [指数与对数函数](#指数与对数函数)
    - [数值处理函数](#数值处理函数)
    - [特殊数学函数](#特殊数学函数)
    - [数值属性函数](#数值属性函数)
    - [直方图桶函数](#直方图桶函数)
  - [3. 随机数函数](#3-随机数函数)
  - [4. 三角函数](#4-三角函数)
    - [弧度制三角函数](#弧度制三角函数)
    - [度数制三角函数](#度数制三角函数)
  - [5. 双曲函数](#5-双曲函数)
  - [支持的数据类型](#支持的数据类型)
  - [重要特性说明](#重要特性说明)
    - [类型提升规则](#类型提升规则)
    - [精度差异](#精度差异)
    - [舍入规则](#舍入规则)
    - [随机数特性](#随机数特性)
  - [使用建议](#使用建议)
    - [数据类型选择](#数据类型选择)
    - [函数选择指导](#函数选择指导)
    - [性能优化建议](#性能优化建议)
    - [兼容性注意事项](#兼容性注意事项)

<!-- /code_chunk_output -->

# PostgreSQL 17.7 数学函数与操作符完整文档

## 概述

PostgreSQL 17 提供了丰富的数学函数和操作符，支持多种数值类型（smallint、integer、bigint、numeric、real、double precision）的运算。本文档详细介绍了 PostgreSQL 17.7 版本中的所有数学函数和操作符，包括基础算术、高级数学运算、随机数生成和三角函数等功能。

### 功能特点

- **全面性**：涵盖 PostgreSQL 17.7 的所有数学函数和操作符
- **实用性强**：提供丰富的示例代码和使用场景
- **类型安全**：详细说明各个函数支持的数据类型
- **性能指导**：针对不同需求提供最佳实践建议

## 1. 数学操作符

### 基础算术操作符

| 操作符 | 描述 | 示例 |
|--------|------|------|
| `numeric_type + numeric_type` | 加法 | `2 + 3` → `5` |
| `+numeric_type` | 一元加法（无操作） | `+ 3.5` → `3.5` |
| `numeric_type - numeric_type` | 减法 | `2 - 3` → `-1` |
| `-numeric_type` | 取负 | `- (-4)` → `4` |
| `numeric_type * numeric_type` | 乘法 | `2 * 3` → `6` |
| `numeric_type / numeric_type` | 除法（整数除法向零截断） | `5 / 2` → `2` |
| | | `5.0 / 2` → `2.5` |
| | | `(-5) / 2` → `-2` |
| `numeric_type % numeric_type` | 取模（余数） | `5 % 4` → `1` |

### 特殊操作符

| 操作符 | 描述 | 示例 |
|--------|------|------|
| `numeric ^ numeric` | 指数运算（左结合性） | `2 ^ 3` → `8` |
| `double precision ^ double precision` | 指数运算（左结合性） | `2 ^ 3 ^ 3` → `512` |
| | | `2 ^ (3 ^ 3)` → `134217728` |
| `\|/ double precision` | 平方根 | `\|/ 25.0` → `5` |
| `\|\|/ double precision` | 立方根 | `\|\|/ 64.0` → `4` |
| `@ numeric_type` | 绝对值 | `@ -5.0` → `5.0` |

### 位操作符（整数类型）

| 操作符 | 描述 | 示例 |
|--------|------|------|
| `integral_type & integral_type` | 按位与 | `91 & 15` → `11` |
| `integral_type \| integral_type` | 按位或 | `32 \| 3` → `35` |
| `integral_type # integral_type` | 按位异或 | `17 # 5` → `20` |
| `~ integral_type` | 按位非 | `~1` → `-2` |
| `integral_type << integer` | 左移位 | `1 << 4` → `16` |
| `integral_type >> integer` | 右移位 | `8 >> 2` → `2` |

## 2. 数学函数

### 基础数学函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `abs(numeric_type)` | 绝对值 | `abs(-17.4)` → `17.4` |
| `cbrt(double precision)` | 立方根 | `cbrt(64.0)` → `4` |
| `sqrt(numeric)` | 平方根 | `sqrt(2)` → `1.4142135623730951` |
| `sqrt(double precision)` | 平方根 | `sqrt(2.0)` → `1.4142135623730951` |
| `power(a numeric, b numeric)` | a 的 b 次方 | `power(9, 3)` → `729` |
| `power(a double precision, b double precision)` | a 的 b 次方 | `power(9.0, 3.0)` → `729` |
| `factorial(bigint)` | 阶乘 | `factorial(5)` → `120` |

### 取整函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `ceil(numeric)` | 大于等于参数的最小整数 | `ceil(42.2)` → `43` |
| `ceil(double precision)` | 大于等于参数的最小整数 | `ceil(-42.8)` → `-42` |
| `ceiling(numeric)` | 大于等于参数的最小整数（与 ceil 相同） | `ceiling(95.3)` → `96` |
| `ceiling(double precision)` | 大于等于参数的最小整数（与 ceil 相同） | `ceiling(95.3)` → `96` |
| `floor(numeric)` | 小于等于参数的最大整数 | `floor(42.8)` → `42` |
| `floor(double precision)` | 小于等于参数的最大整数 | `floor(-42.8)` → `-43` |
| `round(numeric)` | 四舍五入到最近整数 | `round(42.4)` → `42` |
| `round(double precision)` | 四舍五入到最近整数 | `round(42.4)` → `42` |
| `round(v numeric, s integer)` | 四舍五入到 s 位小数 | `round(42.4382, 2)` → `42.44` |
| | | `round(1234.56, -1)` → `1230` |
| `trunc(numeric)` | 向零截断到整数 | `trunc(42.8)` → `42` |
| `trunc(double precision)` | 向零截断到整数 | `trunc(-42.8)` → `-42` |
| `trunc(v numeric, s integer)` | 向零截断到 s 位小数 | `trunc(42.4382, 2)` → `42.43` |

### 指数与对数函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `exp(numeric)` | e 的 x 次方 | `exp(1.0)` → `2.7182818284590452` |
| `exp(double precision)` | e 的 x 次方 | `exp(1.0)` → `2.718281828459045` |
| `ln(numeric)` | 自然对数 | `ln(2.0)` → `0.6931471805599453` |
| `ln(double precision)` | 自然对数 | `ln(2.0)` → `0.693147180559945` |
| `log(numeric)` | 常用对数（以 10 为底） | `log(100)` → `2` |
| `log(double precision)` | 常用对数（以 10 为底） | `log(100.0)` → `2` |
| `log10(numeric)` | 常用对数（与 log 相同） | `log10(1000)` → `3` |
| `log10(double precision)` | 常用对数（与 log 相同） | `log10(1000.0)` → `3` |
| `log(b numeric, x numeric)` | 以 b 为底的对数 | `log(2.0, 64.0)` → `6.0000000000000000` |

### 数值处理函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `gcd(numeric_type, numeric_type)` | 最大公约数 | `gcd(1071, 462)` → `21` |
| `lcm(numeric_type, numeric_type)` | 最小公倍数 | `lcm(1071, 462)` → `23562` |
| `div(y numeric, x numeric)` | 整数商（向零截断） | `div(9, 4)` → `2` |
| `mod(y numeric_type, x numeric_type)` | 余数 | `mod(9, 4)` → `1` |
| `sign(numeric)` | 符号函数（-1, 0, 或 +1） | `sign(-8.4)` → `-1` |
| `sign(double precision)` | 符号函数（-1, 0, 或 +1） | `sign(-8.4)` → `-1` |

### 特殊数学函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `pi()` | 圆周率 π | `pi()` → `3.141592653589793` |
| `degrees(double precision)` | 弧度转角度 | `degrees(0.5)` → `28.64788975654116` |
| `radians(double precision)` | 角度转弧度 | `radians(45.0)` → `0.7853981633974483` |
| `erf(double precision)` | 误差函数 | `erf(1.0)` → `0.8427007929497149` |
| `erfc(double precision)` | 互补误差函数 | `erfc(1.0)` → `0.15729920705028513` |

### 数值属性函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `min_scale(numeric)` | 精确表示所需的最少小数位数 | `min_scale(8.4100)` → `2` |
| `scale(numeric)` | 参数的小数位数 | `scale(8.4100)` → `4` |
| `trim_scale(numeric)` | 移除尾部的零 | `trim_scale(8.4100)` → `8.41` |

### 直方图桶函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `width_bucket(operand numeric, low numeric, high numeric, count integer)` | 等宽桶分布 | `width_bucket(5.35, 0.024, 10.06, 5)` → `3` |
| | | `width_bucket(9, 10, 0, 10)` → `2` |
| `width_bucket(operand anycompatible, thresholds anycompatiblearray)` | 数组桶分布 | `width_bucket(now(), array['yesterday', 'today', 'tomorrow']::timestamptz[])` → `2` |

## 3. 随机数函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `random()` | 0.0 到 1.0 之间的随机数 | `random()` → `0.897124072839091` |
| `random(min integer, max integer)` | 整数范围随机数 | `random(1, 10)` → `7` |
| `random(min numeric, max numeric)` | 数值范围随机数 | `random(-0.499, 0.499)` → `0.347` |
| `random_normal([mean double precision [, stddev double precision]])` | 正态分布随机数 | `random_normal(0.0, 1.0)` → `0.051285419` |
| `setseed(double precision)` | 设置随机数种子 | `setseed(0.12345)` |

**注意**：`random()` 和 `random_normal()` 使用确定性伪随机数生成器，速度快但不适合加密应用。

## 4. 三角函数

### 弧度制三角函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `sin(double precision)` | 正弦（弧度） | `sin(1)` → `0.8414709848078965` |
| `cos(double precision)` | 余弦（弧度） | `cos(0)` → `1` |
| `tan(double precision)` | 正切（弧度） | `tan(1)` → `1.5574077246549023` |
| `cot(double precision)` | 余切（弧度） | `cot(0.5)` → `1.830487721712452` |
| `asin(double precision)` | 反正弦（弧度） | `asin(1)` → `1.5707963267948966` |
| `acos(double precision)` | 反余弦（弧度） | `acos(1)` → `0` |
| `atan(double precision)` | 反正切（弧度） | `atan(1)` → `0.7853981633974483` |
| `atan2(y double precision, x double precision)` | 反正切 y/x（弧度） | `atan2(1, 0)` → `1.5707963267948966` |

### 度数制三角函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `sind(double precision)` | 正弦（度数） | `sind(30)` → `0.5` |
| `cosd(double precision)` | 余弦（度数） | `cosd(60)` → `0.5` |
| `tand(double precision)` | 正切（度数） | `tand(45)` → `1` |
| `cotd(double precision)` | 余切（度数） | `cotd(45)` → `1` |
| `asind(double precision)` | 反正弦（度数） | `asind(0.5)` → `30` |
| `acosd(double precision)` | 反余弦（度数） | `acosd(0.5)` → `60` |
| `atand(double precision)` | 反正切（度数） | `atand(1)` → `45` |
| `atan2d(y double precision, x double precision)` | 反正切 y/x（度数） | `atan2d(1, 0)` → `90` |

**建议**：使用度数制三角函数可以避免特殊值（如 `sind(30)`）的舍入误差。

## 5. 双曲函数

| 函数 | 描述 | 示例 |
|------|------|------|
| `sinh(double precision)` | 双曲正弦 | `sinh(1)` → `1.1752011936438014` |
| `cosh(double precision)` | 双曲余弦 | `cosh(0)` → `1` |
| `tanh(double precision)` | 双曲正切 | `tanh(1)` → `0.7615941559557649` |
| `asinh(double precision)` | 反双曲正弦 | `asinh(1)` → `0.881373587019543` |
| `acosh(double precision)` | 反双曲余弦 | `acosh(1)` → `0` |
| `atanh(double precision)` | 反双曲正切 | `atanh(0.5)` → `0.5493061443340548` |

## 支持的数据类型

- **整数类型**：`smallint`、`integer`、`bigint`
- **精确数值**：`numeric`
- **浮点类型**：`real`、`double precision`

## 重要特性说明

### 类型提升规则

- 多参数类型调用时，使用类型列表中后出现的类型
- 例如：`integer + numeric` 的结果类型为 `numeric`

### 精度差异

- `numeric` 类型提供高精度计算
- `double precision` 函数精度依赖主机系统的 C 库

### 舍入规则

- `numeric` 类型：向零舍入
- `double precision` 类型：通常向最近的偶数舍入（平台相关）

### 随机数特性

- 使用确定性伪随机数生成器
- 适合快速生成，不适合加密应用
- 可通过 `setseed()` 重现随机序列

## 使用建议

### 数据类型选择

1. **精确计算**：使用 `numeric` 类型
   - 金融计算需要精确结果
   - 需要控制小数位数的场景
   - 避免浮点数精度问题

2. **高性能计算**：使用 `double precision` 类型
   - 科学计算和统计分析
   - 大规模数据处理
   - 可以容忍微小精度误差的场景

### 函数选择指导

1. **三角函数**：优先使用度数制版本
   - `sind(30)` 比 `sin(radians(30))` 更精确
   - 避免 `π/6` 等特殊值的舍入误差
   - 代码更易读和维护

2. **随机数**：用于非加密目的，必要时设置种子
   - 使用 `setseed()` 确保可重现的结果
   - 注意 `random()` 不适合加密用途
   - `random_normal()` 适合统计模拟

3. **位操作**：仅适用于整数类型
   - 用于权限控制和状态标记
   - 高效的布尔运算实现

4. **直方图分析**：使用 `width_bucket` 函数
   - 数据分布分析
   - 统计报表生成

### 性能优化建议

- 在批量操作中，选择合适的数据类型以避免隐式类型转换
- 对于大量计算，考虑使用 `double precision` 提高性能
- 随机数生成时，合理设置种子以平衡随机性和可重现性
- 位运算操作比算术运算更高效，在适当场景下优先使用

### 兼容性注意事项

- 不同 PostgreSQL 版本的函数行为可能略有差异
- `numeric` 类型的精度在不同平台上一致
- `double precision` 的精度可能依赖底层系统实现

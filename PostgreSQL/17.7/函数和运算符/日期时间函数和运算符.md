# PostgreSQL 17.7 日期时间函数和运算符

PostgreSQL 提供了丰富的日期时间函数和运算符，用于处理各种日期时间数据类型的计算、转换和操作。

## 核心日期时间运算符（最常用）

### 基本算术运算
```sql
-- 日期加减运算
SELECT date '2001-09-28' + 7;                    -- 2001-10-05
SELECT date '2001-10-01' - 7;                    -- 2001-09-24
SELECT date '2001-10-01' - date '2001-09-28';    -- 3 (天数差)

-- 时间戳与间隔运算
SELECT timestamp '2001-09-28 01:00' + interval '23 hours';    -- 2001-09-29 00:00:00
SELECT timestamp '2001-09-28 23:00' - interval '23 hours';    -- 2001-09-28 00:00:00

-- 间隔运算
SELECT interval '1 day' + interval '1 hour';                 -- 1 day 01:00:00
SELECT interval '1 hour' * 3.5;                             -- 03:30:00
SELECT interval '1 hour' / 1.5;                             -- 00:40:00
```

### 时间戳比较和减法
```sql
-- 时间戳相减得到间隔
SELECT timestamp '2001-09-29 03:00' - timestamp '2001-07-27 12:00';
-- 63 days 15:00:00

-- 时间相减得到间隔
SELECT time '05:00' - time '03:00';                         -- 02:00:00
```

## 核心日期时间函数（日常必需）

### 1. 当前时间函数（高频使用）

```sql
-- 获取当前日期时间（不同变体）
SELECT CURRENT_DATE;                    -- 2024-01-15
SELECT CURRENT_TIME;                    -- 14:30:25.123456+08
SELECT CURRENT_TIMESTAMP;               -- 2024-01-15 14:30:25.123456+08
SELECT CURRENT_TIMESTAMP(0);            -- 2024-01-15 14:30:25+08 (精确到秒)

SELECT LOCALTIME;                       -- 14:30:25.123456
SELECT LOCALTIMESTAMP;                  -- 2024-01-15 14:30:25.123456

-- PostgreSQL 特有函数
SELECT now();                           -- 等同于 CURRENT_TIMESTAMP
SELECT clock_timestamp();               -- 语句执行期间会变化
SELECT transaction_timestamp();         -- 事务开始时间
SELECT statement_timestamp();           -- 语句开始时间
```

### 2. `EXTRACT` / `date_part` - 提取日期时间字段

```sql
-- 基本字段提取
SELECT EXTRACT(YEAR FROM CURRENT_DATE);                    -- 2024
SELECT EXTRACT(MONTH FROM CURRENT_DATE);                   -- 1
SELECT EXTRACT(DAY FROM CURRENT_DATE);                     -- 15
SELECT EXTRACT(HOUR FROM CURRENT_TIME);                    -- 14
SELECT EXTRACT(MINUTE FROM CURRENT_TIME);                  -- 30

-- 高级字段提取
SELECT EXTRACT(QUARTER FROM CURRENT_DATE);                 -- 1 (第几季度)
SELECT EXTRACT(WEEK FROM CURRENT_DATE);                    -- 3 (ISO周数)
SELECT EXTRACT(DOW FROM CURRENT_DATE);                     -- 1 (星期日=0, 星期一=1)
SELECT EXTRACT(ISODOW FROM CURRENT_DATE);                  -- 1 (ISO标准: 星期一=1)
SELECT EXTRACT(DOY FROM CURRENT_DATE);                     -- 15 (一年中的第几天)

-- 时间戳相关
SELECT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP);              -- Unix 时间戳
SELECT EXTRACT(TIMEZONE FROM CURRENT_TIMESTAMP);           -- 时区偏移(秒)
```

### 3. `date_trunc` - 日期时间截断

```sql
-- 截断到指定精度
SELECT date_trunc('year', CURRENT_TIMESTAMP);              -- 2024-01-01 00:00:00
SELECT date_trunc('month', CURRENT_TIMESTAMP);             -- 2024-01-01 00:00:00
SELECT date_trunc('day', CURRENT_TIMESTAMP);               -- 2024-01-15 00:00:00
SELECT date_trunc('hour', CURRENT_TIMESTAMP);              -- 2024-01-15 14:00:00
SELECT date_trunc('minute', CURRENT_TIMESTAMP);            -- 2024-01-15 14:30:00

-- 指定时区截断
SELECT date_trunc('day', CURRENT_TIMESTAMP, 'UTC');        -- UTC时区的午夜

-- 间隔截断
SELECT date_trunc('hour', INTERVAL '3 days 02:47:33');     -- 3 days 02:00:00
```

### 4. `date_bin` - 时间分组（实用工具）

```sql
-- 按指定间隔分组时间
SELECT date_bin('15 minutes', TIMESTAMP '2020-02-11 15:44:17', TIMESTAMP '2001-01-01');
-- 2020-02-11 15:30:00

SELECT date_bin('1 hour', CURRENT_TIMESTAMP, TIMESTAMP '2001-01-01');
-- 当前小时开始时间

-- 常用于时间序列数据分析
SELECT
    date_bin('5 minutes', created_at, TIMESTAMP '2001-01-01') as time_bucket,
    COUNT(*) as count
FROM orders
GROUP BY time_bucket
ORDER BY time_bucket;
```

### 5. `age` - 计算年龄或时间差

```sql
-- 计算两个日期之间的符号化差值
SELECT age(timestamp '2001-04-10', timestamp '1957-06-13');
-- 43 years 9 mons 27 days

-- 计算与当前日期的差值
SELECT age(timestamp '1957-06-13');
-- 66 years 6 mons 10 days (相对于当前日期)

-- 与简单减法的区别
SELECT age(timestamptz '2013-07-01 12:00:00', timestamptz '2013-03-01 12:00:00');
-- 4 mons (按月日计算)

SELECT timestamptz '2013-07-01 12:00:00' - timestamptz '2013-03-01 12:00:00';
-- 121 days 23:00:00 (按实际时间计算)
```

## 时区转换函数（重要）

### `AT TIME ZONE` 运算符

```sql
-- 为无时区时间戳添加时区
SELECT timestamp '2001-02-16 20:38:40' AT TIME ZONE 'America/New_York';
-- 2001-02-17 09:38:40+08 (转换为会话时区)

-- 转换带时区时间戳到其他时区
SELECT timestamp with time zone '2001-02-16 20:38:40-05' AT TIME ZONE 'Asia/Tokyo';
-- 2001-02-17 10:38:40 (无时区结果)

-- 转换到本地时区
SELECT timestamp with time zone '2001-02-16 20:38:40-05' AT LOCAL;
-- 2001-02-17 09:38:40 (本地时区时间)

-- 时间类型时区转换
SELECT time with time zone '20:38:40-05' AT TIME ZONE 'UTC';
-- 01:38:40+00
```

## 日期时间构造函数

### 基础构造函数

```sql
-- 构造日期
SELECT make_date(2024, 1, 15);                               -- 2024-01-15

-- 构造时间
SELECT make_time(14, 30, 25.5);                              -- 14:30:25.5

-- 构造时间戳
SELECT make_timestamp(2024, 1, 15, 14, 30, 25.5);            -- 2024-01-15 14:30:25.5

-- 构造带时区时间戳
SELECT make_timestamptz(2024, 1, 15, 14, 30, 25.5, 'Asia/Tokyo');
-- 2024-01-15 13:30:25.5+08 (相对于会话时区)

-- 构造间隔
SELECT make_interval(days => 10);                            -- 10 days
SELECT make_interval(hours => 2, minutes => 30);             -- 02:30:00
SELECT make_interval(years => 1, months => 2, days => 3);    -- 1 year 2 mons 3 days
```

### Unix 时间戳转换

```sql
-- Unix 时间戳转时间戳
SELECT to_timestamp(1705288225);                             -- 2024-01-15 06:30:25+08

-- 时间戳转 Unix 时间戳
SELECT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP);                -- 1705288225.123456
```

## 实用工具函数

### 间隔处理函数

```sql
-- 标准化间隔
SELECT justify_hours(INTERVAL '50 hours 10 minutes');        -- 2 days 02:10:00
SELECT justify_days(INTERVAL '1 year 65 days');              -- 1 year 2 mons 5 days
SELECT justify_interval(INTERVAL '1 mon -1 hour');          -- 29 days 23:00:00
```

### 有限性检查

```sql
-- 检查日期时间是否为有限值
SELECT isfinite(date '2001-02-16');                          -- true
SELECT isfinite(timestamp 'infinity');                       -- false
SELECT isfinite(interval '4 hours');                         -- true
```

### 时间重叠检查（OVERLAPS）

```sql
-- 检查两个时间段是否重叠
SELECT (DATE '2001-02-16', DATE '2001-12-21')
       OVERLAPS (DATE '2001-10-30', DATE '2002-10-30');     -- true

-- 使用起始点和持续时间
SELECT (DATE '2001-02-16', INTERVAL '100 days')
       OVERLAPS (DATE '2001-10-30', DATE '2002-10-30');     -- false
```

## 高级和特殊函数（较少使用）

### 特殊时间戳函数

```sql
-- 返回文本格式的时间
SELECT timeofday();                                          -- "Mon Jan 15 14:30:25 2024 CST"

-- 带时区参数的日期加减
SELECT date_add('2021-10-31 00:00:00+02'::timestamptz,
                '1 day'::interval, 'Europe/Warsaw');
-- 考虑夏令时的时间加法

SELECT date_subtract('2021-11-01 00:00:00+01'::timestamptz,
                   '1 day'::interval, 'Europe/Warsaw');
-- 考虑夏令时的时间减法
```

### 时区函数（PostgreSQL 特有）

```sql
-- 时区转换函数（等价于 AT TIME ZONE）
SELECT timezone('Asia/Tokyo', timestamp '2001-02-16 20:38:40');
-- 2001-02-16 20:38:40+09

SELECT timezone('UTC', time with time zone '05:34:17-05');
-- 10:34:17+00
```

## EXTRACT 字段完整参考

### 时间字段（常用）
- `YEAR`: 年份
- `MONTH`: 月份 (1-12)
- `DAY`: 月份中的日 (1-31)
- `HOUR`: 小时 (0-23)
- `MINUTE`: 分钟 (0-59)
- `SECOND`: 秒（包括小数部分）

### 周相关字段
- `DOW`: 星期几（周日=0, 周一=1）
- `ISODOW`: ISO 标准星期几（周一=1, 周日=7）
- `WEEK`: ISO 标准周数
- `ISOYEAR`: ISO 标准年份

### 其他实用字段
- `QUARTER`: 季度 (1-4)
- `DOY`: 一年中的第几天 (1-366)
- `DECADE`: 十位数年份
- `CENTURY`: 世纪
- `MILLENNIUM: 千年
- `EPOCH`: Unix 时间戳（秒）
- `JULIAN`: 儒略日

## date_trunc 截断字段

支持的字段：`microseconds`, `milliseconds`, `second`, `minute`, `hour`, `day`, `week`, `month`, `quarter`, `year`, `decade`, `century`, `millennium`

## 实际开发最佳实践

### 1. 时区处理建议
```sql
-- 始终存储带时区的时间戳
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    name TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 查询时转换到用户时区
SELECT name, created_at AT TIME ZONE user.timezone
FROM events
JOIN users ON events.user_id = users.id;
```

### 2. 性能优化
```sql
-- 对时间范围查询使用索引
CREATE INDEX idx_orders_created_at ON orders(created_at);

-- 使用 date_trunc 进行时间序列分析
SELECT
    date_trunc('day', created_at) as date,
    COUNT(*) as daily_count
FROM orders
WHERE created_at >= date_trunc('month', CURRENT_DATE)
GROUP BY date
ORDER BY date;
```

### 3. 时间计算注意事项
```sql
-- 注意 interval '1 day' 和 interval '24 hours' 的区别
-- 前者考虑夏令时，后者不考虑

-- 使用 age() 获得直观的年龄差
SELECT age(end_date, start_date) as duration
FROM projects;

-- 使用 EXTRACT(EPOCH) 获得精确的秒数差
SELECT EXTRACT(EPOCH FROM (end_time - start_time)) as duration_seconds
FROM measurements;
```

### 4. 当前时间函数选择
- `CURRENT_TIMESTAMP`: 事务内值不变，适合审计日志
- `clock_timestamp()`: 每次调用都变化，适合高精度计时
- `statement_timestamp()`: 语句级别的一致时间
- `now()`: PostgreSQL 特有，等价于 `transaction_timestamp()`

## 兼容性说明

- PostgreSQL 提供了所有 SQL 标准的日期时间函数
- 某些函数如 `date_part` 是 PostgreSQL 特有的，但建议使用标准的 `EXTRACT`
- `OVERLAPS` 操作符是 SQL 标准的
- 时区处理功能比标准 SQL 更强大

## 重要注意事项

1. **时区存储**: 建议使用 `TIMESTAMP WITH TIME ZONE` 存储时间数据
2. **事务一致性**: `CURRENT_TIMESTAMP` 等函数在事务期间返回相同值
3. **夏令时处理**: 使用 `INTERVAL '1 day'` 会自动处理夏令时转换
4. **精度控制**: 可以指定小数秒精度，如 `CURRENT_TIMESTAMP(2)`
5. **无限值**: 支持正负无穷大时间戳，用于特殊场景
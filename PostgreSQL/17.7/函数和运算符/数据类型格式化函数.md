# PostgreSQL 17.7 数据类型格式化函数

PostgreSQL 格式化函数提供了一组强大的工具，用于将各种数据类型（日期/时间、整数、浮点数、数值）转换为格式化字符串，以及将格式化字符串转换为特定的数据类型。

## 核心格式化函数（最常用）

### 1. `to_char` - 数据类型转字符串

最常用的格式化函数，支持多种数据类型：

```sql
to_char ( timestamp, text ) → text
to_char ( interval, text ) → text
to_char ( numeric_type, text ) → text

-- 日期时间格式化
to_char(timestamp '2002-04-20 17:31:12.66', 'HH12:MI:SS')  -- '05:31:12'
to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS')       -- '2024-01-15 14:30:25'

-- 数字格式化
to_char(125, '999')                    -- '125'
to_char(125.8::real, '999D9')          -- '125.8'
to_char(-125.8, '999D99S')             -- '125.80-'
to_char(1234567, '9,999,999')         -- '1,234,567'
to_char(1234.56, '9999.99')            -- ' 1234.56'
```

### 2. `to_date` - 字符串转日期

将格式化的字符串转换为日期类型：

```sql
to_date ( text, text ) → date
to_date('05 Dec 2000', 'DD Mon YYYY')     -- 2000-12-05
to_date('2024-01-15', 'YYYY-MM-DD')       -- 2024-01-15
to_date('15/01/2024', 'DD/MM/YYYY')      -- 2024-01-15
```

### 3. `to_number` - 字符串转数值

将格式化的字符串转换为数值类型：

```sql
to_number ( text, text ) → numeric
to_number('12,454.8-', '99G999D9S')     -- -12454.8
to_number('1,234.56', '9G999D99')       -- 1234.56
to_number('$1,234.56', 'L9G999D99')     -- 1234.56 (使用本地化货币符号)
```

### 4. `to_timestamp` - 字符串转时间戳

将格式化的字符串转换为带时区的时间戳：

```sql
to_timestamp ( text, text ) → timestamp with time zone
to_timestamp('05 Dec 2000', 'DD Mon YYYY')       -- 2000-12-05 00:00:00+08
to_timestamp('2024-01-15 14:30:25', 'YYYY-MM-DD HH24:MI:SS') -- 2024-01-15 14:30:25+08
```

## 常用日期时间格式化模式

### 基础时间格式（高频使用）

- `HH` / `HH12`: 小时(01-12)
- `HH24`: 24小时制(00-23)
- `MI`: 分钟(00-59)
- `SS`: 秒(00-59)
- `MS`: 毫秒(000-999)
- `US`: 微秒(000000-999999)

### 日期格式（日常必需）

- `YYYY`: 4位年份
- `MM`: 月份(01-12)
- `DD`: 日期(01-31)
- `MON`: 缩写月份名称(Jan, Feb, Mar)
- `MONTH`: 完整月份名称(January)
- `DAY`: 星期名称(Monday, Tuesday)
- `DY`: 缩写星期名称(Mon, Tue)

### 实用格式组合

```sql
-- ISO 8601 格式
to_char(current_timestamp AT TIME ZONE 'UTC', 'YYYY-MM-DD"T"HH24:MI:SS"Z"')  -- 2025-12-19T13:15:33Z

-- 美式日期格式
to_char(current_date, 'MM/DD/YYYY')

-- 欧式日期格式
to_char(current_date, 'DD.MM.YYYY')

-- 中文友好的格式
to_char(current_timestamp, 'YYYY"年"MM"月"DD"日" HH24"时"MI"分"')
```

## 常用数字格式化模式

### 基础数字格式

- `9`: 数字位置（可省略前导零）
- `0`: 数字位置（保留前导零）
- `.`: 小数点
- `,`: 千位分隔符

### 实用数字格式示例

```sql
-- 基础格式化
to_char(1234.5, '9999.99')        -- ' 1234.50'
to_char(1234.5, '0999.99')        -- '1234.50'
to_char(1234.5, 'FM9999.99')      -- '1234.5' (去除前导空格)

-- 千位分隔符
to_char(1234567, '9,999,999')     -- '1,234,567'
to_char(1234567, '9G999G999')     -- '1 234 567' (本地化)

-- 负数处理
to_char(-1234.5, '9999.99S')      -- '1234.50-'
to_char(-1234.5, 'S9999.99')      -- '-1234.50'
to_char(-1234.5, '9999.99MI')     -- '1234.50-'
to_char(-1234.5, '9999.99PR')     -- '<1234.50>'
```

## 格式化修饰符（重要）

### `FM` - 填充模式（去除多余空格和零）

```sql
to_char(current_timestamp, 'Day, DD  HH12:MI:SS')     -- 'Tuesday  , 06  05:39:18'
to_char(current_timestamp, 'FMDay, FMDD  HH12:MI:SS') -- 'Tuesday, 6  05:39:18'

to_char(1234.5, '9999.99')     -- ' 1234.50'
to_char(1234.5, 'FM9999.99')   -- '1234.5'
```

### `FX` - 固定格式选项

严格要求输入格式匹配，常用于数据验证：

```sql
-- 这样会成功
to_timestamp('2000 JUN', 'YYYY MON')  -- 2000-06-01 00:00:00+08

-- 使用FX后会失败，因为期望只有一个空格
to_timestamp('2000    JUN', 'FXYYYY MON')
```

## 实际开发中的最佳实践

### 1. ISO 8601 标准格式（推荐）

```sql
-- 标准日期时间格式
to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS') -- 2025-12-19 21:18:08
-- 标准时间戳格式
to_char(current_timestamp AT TIME ZONE 'UTC', 'YYYY-MM-DD"T"HH24:MI:SS"Z"') -- 2025-12-19T13:18:22Z
```

### 2. 本地化格式

```sql
-- 使用本地化的分隔符和符号
to_char(1234.56, '9G999D99')  -- 使用本地化的千位分隔符和小数点
to_char(1234.56, 'L9G999D99') -- 使用本地化的货币符号
```

### 3. 性能优化建议

- 对于标准日期时间格式，优先使用简单类型转换而非 `to_char`
- 只在需要复杂格式化时使用格式化函数
- 批量处理时考虑格式化函数的开销

### 4. 错误处理

```sql
-- 安全转换，处理可能的错误
BEGIN
    SELECT to_date('invalid date', 'YYYY-MM-DD');
EXCEPTION WHEN others THEN
    NULL; -- 或处理错误
END;
```

## 高级和特殊功能（较少使用）

### 间隔格式化

```sql
to_char(interval '15h 2m 12s', 'HH24:MI:SS')  -- '15:02:12'
```

### 科学计数法

```sql
to_char(0.0004859, '9.99EEEE')  -- ' 4.86e-04'
```

### 罗马数字

```sql
to_char(2024, 'RN')        -- 'MMXXIV'
to_char(2024, 'FMRN')      -- 'MMXXIV' (无前导空格)
```

### 序数后缀

```sql
to_char(1, '999th')   -- ' 1st'
to_char(2, '999th')   -- ' 2nd'
to_char(3, '999th')   -- ' 3rd'
```

## 完整格式化模式参考

### 日期时间格式化模式

| 模式 | 描述 |
|------|------|
| `HH` | 小时(01-12) |
| `HH12` | 小时(01-12) |
| `HH24` | 小时(00-23) |
| `MI` | 分钟(00-59) |
| `SS` | 秒(00-59) |
| `MS` | 毫秒(000-999) |
| `US` | 微秒(000000-999999) |
| `FF1` | 十分之一秒(0-9) |
| `FF2` | 百分之一秒(00-99) |
| `FF3` | 毫秒(000-999) |
| `FF4` | 毫秒的十分之一(0000-9999) |
| `FF5` | 毫秒的百分之一(00000-99999) |
| `FF6` | 微秒(000000-999999) |
| `SSSS`, `SSSSS` | 午夜后的秒数(0-86399) |
| `AM`, `am`, `PM`, `pm` | 上午/下午指示符(无句点) |
| `A.M.`, `a.m.`, `P.M.`, `p.m.` | 上午/下午指示符(带句点) |
| `Y,YYY` | 年份(4位或更多)带逗号 |
| `YYYY` | 年份(4位或更多) |
| `YYY` | 年份的最后3位 |
| `YY` | 年份的最后2位 |
| `Y` | 年份的最后1位 |
| `IYYY` | ISO 8601 周编号年份(4位或更多) |
| `IYY` | ISO 8601 周编号年份的最后3位 |
| `IY` | ISO 8601 周编号年份的最后2位 |
| `I` | ISO 8601 周编号年份的最后1位 |
| `BC`, `bc`, `AD`, `ad` | 纪元指示符(无句点) |
| `B.C.`, `b.c.`, `A.D.`, `a.d.` | 纪元指示符(带句点) |
| `MONTH` | 完整大写月份名称(空格填充至9字符) |
| `Month` | 完整首字母大写月份名称(空格填充至9字符) |
| `month` | 完整小写月份名称(空格填充至9字符) |
| `MON` | 缩写大写月份名称(英语中3字符，本地化长度可变) |
| `Mon` | 缩写首字母大写月份名称(英语中3字符，本地化长度可变) |
| `mon` | 缩写小写月份名称(英语中3字符，本地化长度可变) |
| `MM` | 月份编号(01-12) |
| `DAY` | 完整大写日期名称(空格填充至9字符) |
| `Day` | 完整首字母大写日期名称(空格填充至9字符) |
| `day` | 完整小写日期名称(空格填充至9字符) |
| `DY` | 缩写大写日期名称(英语中3字符，本地化长度可变) |
| `Dy` | 缩写首字母大写日期名称(英语中3字符，本地化长度可变) |
| `dy` | 缩写小写日期名称(英语中3字符，本地化长度可变) |
| `DDD` | 年中的日(001-366) |
| `IDDD` | ISO 8601 周编号年份中的日(001-371) |
| `DD` | 月中的日(01-31) |
| `D` | 星期中的日，周日(1)到周六(7) |
| `ID` | ISO 8601 星期中的日，周一(1)到周日(7) |
| `W` | 月中的周(1-5) |
| `WW` | 年中的周(1-53) |
| `IW` | ISO 8601 周编号年份中的周(01-53) |
| `CC` | 世纪(2位数字) |
| `J` | 儒略日(自公元前4714年11月24日以来的整数天数) |
| `Q` | 季度 |
| `RM` | 大写罗马数字月份(I-XII; I=一月) |
| `rm` | 小写罗马数字月份(i-xii; i=一月) |
| `TZ` | 大写时区缩写 |
| `tz` | 小写时区缩写 |
| `TZH` | 时区小时 |
| `TZM` | 时区分钟 |
| `OF` | 与UTC的时区偏移(HH或HH:MM) |

### 数字格式化模式

| 模式 | 描述 |
|------|------|
| `9` | 数字位置(如果可以省略则省略) |
| `0` | 数字位置(即使不重要也不会省略) |
| `.` (句点) | 小数点 |
| `,` (逗号) | 组(千位)分隔符 |
| `PR` | 尖括号中的负值 |
| `S` | 锚定到数字的符号(使用本地化) |
| `L` | 货币符号(使用本地化) |
| `D` | 小数点(使用本地化) |
| `G` | 组分隔符(使用本地化) |
| `MI` | 指定位置中的减号(如果数字<0) |
| `PL` | 指定位置中的加号(如果数字>0) |
| `SG` | 指定位置中的加/减号 |
| `RN` | 罗马数字(输入在1和3999之间) |
| `TH` 或 `th` | 序数后缀 |
| `V` | 移动指定数字位数(见说明) |
| `EEEE` | 科学计数法的指数 |

### 修饰符

| 修饰符 | 描述 | 示例 |
|--------|------|------|
| `FM` 前缀 | 填充模式(抑制前导零和填充空格) | `FMMonth` |
| `TH` 后缀 | 大写序数后缀 | `DDTH`, 例如 `12TH` |
| `th` 后缀 | 小写序数后缀 | `DDth`, 例如 `12th` |
| `FX` 前缀 | 固定格式全局选项 | `FX Month DD Day` |
| `TM` 前缀 | 翻译模式(使用基于lc_time的本地化日期和月份名称) | `TMMonth` |
| `SP` 后缀 | 拼写模式(未实现) | `DDSP` |

## 重要注意事项

1. **大小写敏感性**: `to_timestamp` 和 `to_date` 在输入时忽略字母大小写
2. **年份处理**: 小于4位的年份会自动调整到接近2020年
3. **时区处理**: 使用 `AT TIME ZONE` 子句处理时区转换
4. **本地化设置**: 格式化可能受数据库本地化设置影响
5. **PostgreSQL 12+ 变化**: 任意文本跳过规则发生变化，需要注意向后兼容性
6. **毫秒和微秒处理**: 在 `to_timestamp` 中，毫秒和微秒字段用作小数点后的秒数字
7. **分隔符匹配**: 在 `to_timestamp` 和 `to_date` 中，模板字符串中的分隔符匹配输入字符串中的任意单个分隔符或被跳过

## 兼容性说明

- 大部分格式化函数与 Oracle 兼容
- 某些修饰符（如 `PL`, `SG`, `TH`）是 PostgreSQL 扩展
- 在 Oracle 中，`FM` 修饰符影响所有后续规范，而在 PostgreSQL 中只影响下一个规范

## 性能考虑

1. 对于标准日期时间格式，优先使用简单类型转换而非 `to_char`
2. 只在需要复杂格式化时使用格式化函数
3. 批量处理时考虑格式化函数的开销
4. `to_number` 对于标准数值表示是不必要的

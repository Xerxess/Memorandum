# PostgreSQL 17.7 文本搜索功能和运算符

PostgreSQL 提供了强大的全文搜索功能，包括专门的文本搜索数据类型（`tsvector` 和 `tsquery`）、运算符和函数。这些功能支持高效的文本搜索、排序和高亮显示。

- to_tsvector (分词器) 该函数将原始文档（文本）转换为 tsvector（分词向量）。它会进行分词、去除停用词（如 "the", "a"）以及词干提取（Stemming）。
- to_tsquery (查询器) 该函数将用户输入的搜索词转换为 tsquery（查询条件）。它必须配合逻辑操作符使用。
  - & (AND)：同时包含
  - | (OR)：包含其一
  - ! (NOT)：不包含
  - <-> (FOLLOWED BY)：紧邻（2025 年常用的短语搜索）

## 核心文本搜索运算符（最常用）

### 1. 匹配运算符 `@@`

这是全文搜索的核心运算符，用于检查文档是否匹配查询条件。

```sql
-- tsvector 匹配 tsquery
SELECT to_tsvector('fat cats ate rats') @@ to_tsquery('cat & rat');
-- t (true)

-- 文本直接匹配 tsquery（自动转换为 tsvector）
SELECT 'fat cats ate rats' @@ to_tsquery('cat & rat');
-- t

-- 实际应用示例
SELECT title, content
FROM articles
WHERE to_tsvector('english', title || ' ' || content) @@ to_tsquery('english', 'database & performance');
```

### 2. 查询组合运算符

```sql
-- AND 运算
SELECT 'fat | rat'::tsquery && 'cat'::tsquery;
-- ( 'fat' | 'rat' ) & 'cat'

-- OR 运算
SELECT 'fat | rat'::tsquery || 'cat'::tsquery;
-- 'fat' | 'rat' | 'cat'

-- NOT 运算
SELECT !! 'cat'::tsquery;
-- !'cat'

-- 短语查询（相邻词）
SELECT to_tsquery('fat') <-> to_tsquery('rat');
-- 'fat' <-> 'rat'

-- 包含关系检查
SELECT 'cat'::tsquery <@ 'cat & rat'::tsquery;
-- t (true)
```

### 3. tsvector 连接运算符

```sql
-- 连接两个 tsvector
SELECT 'a:1 b:2'::tsvector || 'c:1 d:2 b:3'::tsvector;
-- 'a':1 'b':2,5 'c':3 'd':4
```

## 核心文本搜索函数（日常必需）

### 1. 基础转换函数

#### `to_tsvector` - 文档转换为搜索向量

```sql
-- 使用默认配置
SELECT to_tsvector('The Fat Rats');
-- 'fat':2 'rat':3

-- 指定配置
SELECT to_tsvector('english', 'The Fat Rats');
-- 'fat':2 'rat':3

-- 处理 JSON 数据
SELECT to_tsvector('english', '{"title": "PostgreSQL Guide", "content": "Database tutorial"}'::json);
-- 'databas':4 'guid':2 'postgresql':1 'tutori':5

-- 创建搜索索引的示例
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    search_vector tsvector
);

-- 创建 GIN 索引
CREATE INDEX idx_articles_search ON articles USING GIN(search_vector);

-- 自动更新搜索向量
CREATE OR REPLACE FUNCTION update_search_vector()
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector := to_tsvector('english', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.content, ''));
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_search_vector
    BEFORE INSERT OR UPDATE ON articles
    FOR EACH ROW EXECUTE FUNCTION update_search_vector();
```

#### `to_tsquery` - 查询转换为搜索查询

```sql
-- 基本转换
SELECT to_tsquery('english', 'database & performance');
-- 'databas' & 'perform'

-- 复杂查询
SELECT to_tsquery('english', '(database | system) & performance & !slow');
-- 'databas' | 'system' & 'perform' & !'slow'

-- 实际搜索应用
SELECT id, title,
       ts_rank(search_vector, query) as rank
FROM articles,
     to_tsquery('english', 'database & performance') query
WHERE search_vector @@ query
ORDER BY rank DESC
LIMIT 10;
```

### 2. 简化查询函数

#### `plainto_tsquery` - 简单文本转查询

```sql
-- 自动处理 AND 连接
SELECT plainto_tsquery('english', 'The Fat Rats');
-- 'fat' & 'rat'

-- 忽略标点和停用词
SELECT plainto_tsquery('This is a test document about database systems');
-- 'test' & 'document' & 'databas' & 'system'

-- 用于用户输入搜索
CREATE OR REPLACE FUNCTION search_articles(search_term TEXT)
RETURNS TABLE(id INTEGER, title TEXT, rank REAL) AS $$
BEGIN
    RETURN QUERY
    SELECT a.id, a.title, ts_rank(a.search_vector, query) as rank
    FROM articles a,
         plainto_tsquery('english', search_term) query
    WHERE a.search_vector @@ query
    ORDER BY rank DESC;
END;
$$ LANGUAGE plpgsql;
```

#### `phraseto_tsquery` - 短语查询

```sql
-- 创建短语查询
SELECT phraseto_tsquery('english', 'The Fat Rats');
-- 'fat' <-> 'rat'

-- 处理包含停用词的短语
SELECT phraseto_tsquery('english', 'The Cat and Rats');
-- 'cat' <2> 'rat'

-- 应用示例：搜索确切短语
SELECT id, title
FROM articles
WHERE search_vector @@ phraseto_tsquery('english', 'database performance');
```

#### `websearch_to_tsquery` - Web 风格搜索

```sql
-- 支持 web 搜索语法
SELECT websearch_to_tsquery('english', '"fat rat" or cat dog');
-- 'fat' <-> 'rat' | 'cat' & 'dog'

-- 支持各种符号
SELECT websearch_to_tsquery('english', 'database -slow performance');
-- 'databas' & 'perform' & !'slow'

-- 实际应用：处理搜索引擎式输入
CREATE OR REPLACE FUNCTION web_search(query_text TEXT)
RETURNS TABLE(id INTEGER, title TEXT, snippet TEXT) AS $$
BEGIN
    RETURN QUERY
    SELECT a.id,
           a.title,
           ts_headline('english', a.content, search_query) as snippet
    FROM articles a,
         websearch_to_tsquery('english', query_text) search_query
    WHERE a.search_vector @@ search_query
    ORDER BY ts_rank(a.search_vector, search_query) DESC;
END;
$$ LANGUAGE plpgsql;
```

### 3. 结果排序和排名函数

#### `ts_rank` - 基础排序

```sql
-- 基础排序计算
SELECT ts_rank(to_tsvector('raining cats and dogs'), 'cat');
-- 0.06079271

-- 自定义权重
SELECT ts_rank('{0.1, 0.2, 0.4, 1.0}', to_tsvector('raining cats and dogs'), 'cat');
-- 0.06079271

-- 使用排序进行搜索结果排序
SELECT id, title,
       ts_rank(search_vector, query) as rank
FROM articles,
     to_tsquery('english', 'database & performance') query
WHERE search_vector @@ query
ORDER BY rank DESC;
```

#### `ts_rank_cd` - 覆盖密度排序

```sql
-- 使用覆盖密度算法
SELECT ts_rank_cd(to_tsvector('raining cats and dogs'), 'cat');
-- 0.1

-- 实际应用示例
SELECT id, title,
       ts_rank_cd('{0.1, 0.2, 0.4, 1.0}', search_vector, query, 2) as rank_cd
FROM articles,
     to_tsquery('english', 'database & performance') query
WHERE search_vector @@ query
ORDER BY rank_cd DESC;
```

### 4. 结果高亮函数

#### `ts_headline` - 搜索结果高亮

```sql
-- 基础高亮
SELECT ts_headline('The fat cat ate the rat.', 'cat');
-- The fat <b>cat</b> ate the rat.

-- 自定义高亮选项
SELECT ts_headline('english', 'The fat cat ate the rat.', 'cat', 'StartSel=<mark>, StopSel=</mark>');
-- The fat <mark>cat</mark> ate the rat.

-- 完整搜索结果展示
SELECT id,
       title,
       ts_headline('english', content, query, 'MaxWords=50, MinWords=10') as snippet
FROM articles,
     to_tsquery('english', 'database & performance') query
WHERE search_vector @@ query
ORDER BY ts_rank(search_vector, query) DESC;

-- JSON 数据高亮
SELECT ts_headline('{"title":"PostgreSQL Guide","content":"database tutorial"}'::jsonb, 'database');
-- {"title":"PostgreSQL Guide", "content":"<b>database</b> tutorial"}
```

## 文本搜索高级功能

### 1. 权重处理

#### `setweight` - 设置词元权重

```sql
-- 为整个向量设置权重
SELECT setweight('fat:2,4 cat:3 rat:5B'::tsvector, 'A');
-- 'cat':3A 'fat':2A,4A 'rat':5A

-- 为特定词元设置权重
SELECT setweight('fat:2,4 cat:3 rat:5,6B'::tsvector, 'A', ARRAY['cat','rat']);
-- 'cat':3A 'fat':2,4 'rat':5A,6A

-- 实际应用：不同字段使用不同权重
CREATE OR REPLACE FUNCTION create_weighted_search_vector(title TEXT, content TEXT, tags TEXT[])
RETURNS tsvector AS $$
BEGIN
    RETURN setweight(to_tsvector('english', title), 'A') ||
           setweight(to_tsvector('english', content), 'B') ||
           setweight(to_tsvector('english', array_to_string(tags, ' ')), 'C');
END;
$$ LANGUAGE plpgsql;

-- 使用权重进行搜索
SELECT id, title,
       ts_rank('{0.8, 0.4, 0.2}',
               create_weighted_search_vector(title, content, tags),
               query) as weighted_rank
FROM articles,
     to_tsquery('english', 'database') query
WHERE create_weighted_search_vector(title, content, tags) @@ query
ORDER BY weighted_rank DESC;
```

### 2. 查询重写

#### `ts_rewrite` - 查询重写

```sql
-- 简单重写
SELECT ts_rewrite('a & b'::tsquery, 'a'::tsquery, 'foo|bar'::tsquery);
-- 'b' & ( 'foo' | 'bar' )

-- 创建同义词重写
CREATE TABLE search_synonyms (
    target tsquery,
    substitute tsquery
);

INSERT INTO search_synonyms VALUES
    ('postgres'::tsquery, 'postgresql|pg'::tsquery),
    ('db'::tsquery, 'database'::tsquery);

-- 使用同义词表重写查询
SELECT ts_rewrite('postgres & db'::tsquery,
                 'SELECT target, substitute FROM search_synonyms');
-- 'postgresql' | 'pg' & 'databas'
```

### 3. 文档统计和分析

#### `ts_stat` - 文档统计

```sql
-- 分析文档中的词频
SELECT * FROM ts_stat('SELECT search_vector FROM articles')
ORDER BY ndoc DESC, nentry DESC, word
LIMIT 20;

-- 统计特定权重的词
SELECT word, ndoc, nentry
FROM ts_stat('SELECT search_vector FROM articles', '{AB}')
ORDER BY nentry DESC;
```

## 实用工具函数

### 1. 向量操作函数

#### `strip` - 移除位置和权重

```sql
-- 移除位置和权重信息
SELECT strip('fat:2,4 cat:3 rat:5A'::tsvector);
-- 'cat' 'fat' 'rat'

-- 用于比较或索引
CREATE INDEX idx_articles_content ON articles USING GIN(strip(search_vector));
```

#### `length` - 计算词元数量

```sql
-- 计算词元数量
SELECT length('fat:2,4 cat:3 rat:5A'::tsvector);
-- 3

-- 文档长度分析
SELECT id, length(search_vector) as term_count
FROM articles
ORDER BY term_count DESC;
```

#### `numnode` - 计算查询节点数

```sql
-- 计算查询复杂度
SELECT numnode('(fat & rat) | cat'::tsquery);
-- 5
```

### 2. 向量过滤和处理

#### `ts_filter` - 按权重过滤

```sql
-- 过滤特定权重的词元
SELECT ts_filter('fat:2,4 cat:3b,7c rat:5A'::tsvector, '{a,b}');
-- 'cat':3B 'rat':5A

-- 只搜索标题词元
SELECT id, title
FROM articles
WHERE ts_filter(search_vector, '{A}') @@ to_tsquery('english', 'database');
```

#### `ts_delete` - 删除特定词元

```sql
-- 删除单个词元
SELECT ts_delete('fat:2,4 cat:3 rat:5A'::tsvector, 'fat');
-- 'cat':3 'rat':5A

-- 批量删除词元
SELECT ts_delete('fat:2,4 cat:3 rat:5A'::tsvector, ARRAY['fat','rat']);
-- 'cat':3

-- 应用：排除停用词
CREATE OR REPLACE FUNCTION remove_stopwords(vector tsvector)
RETURNS tsvector AS $$
DECLARE
    stopwords TEXT[] := ARRAY['the','and','or','but','in','on','at','to','for'];
BEGIN
    RETURN ts_delete(vector, stopwords);
END;
$$ LANGUAGE plpgsql;
```

### 3. 数据类型转换

#### `array_to_tsvector` - 数组转向量

```sql
-- 数组转换为 tsvector
SELECT array_to_tsvector('{fat,cat,rat}'::text[]);
-- 'cat' 'fat' 'rat'

-- 标签搜索
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    title TEXT,
    tags TEXT[]
);

-- 创建标签搜索向量
ALTER TABLE articles ADD COLUMN tag_vector tsvector;
UPDATE articles SET tag_vector = array_to_tsvector(tags);

-- 标签搜索
SELECT title
FROM articles
WHERE tag_vector @@ to_tsquery('simple', 'database & postgresql');
```

#### `tsvector_to_array` - 向量转数组

```sql
-- 提取所有词元
SELECT tsvector_to_array('fat:2,4 cat:3 rat:5A'::tsvector);
-- {cat,fat,rat}
```

#### `unnest` - 展开向量

```sql
-- 展开向量为行
SELECT * FROM unnest('cat:3 fat:2,4 rat:5A'::tsvector);
-- 结果：
-- lexeme | positions | weights
-- cat    | {3}       | {D}
-- fat    | {2,4}     | {D,D}
-- rat    | {5}       | {A}
```

## JSON 文本搜索

### 1. 基础 JSON 搜索

```sql
-- JSON 转 tsvector
SELECT to_tsvector('english', '{"title":"PostgreSQL Guide","content":"Database tutorial"}'::json);
-- 'databas':4 'guid':2 'postgr':1 'tutorial':5

-- 创建 JSON 文章表
CREATE TABLE json_articles (
    id SERIAL PRIMARY KEY,
    data JSONB
);

-- 插入数据
INSERT INTO json_articles VALUES (1, '{
    "title": "PostgreSQL Performance",
    "content": "Learn database optimization",
    "author": "John Doe",
    "tags": ["database", "performance", "postgresql"]
}');

-- 搜索 JSON 数据
SELECT id, data->>'title' as title
FROM json_articles
WHERE to_tsvector('english', data) @@ to_tsquery('english', 'database & performance');
```

### 2. 选择性 JSON 搜索

#### `json_to_tsvector` / `jsonb_to_tsvector`

```sql
-- 只搜索字符串和数值
SELECT json_to_tsvector('english',
    '{"a": "The Fat Rats", "b": 123}'::json,
    '["string", "numeric"]');
-- '123':5 'fat':2 'rat':3

-- 搜索所有类型
SELECT json_to_tsvector('english',
    '{"cat": "The Fat Rats", "dog": 123}'::json,
    '"all"');
-- '123':9 'cat':1 'dog':7 'fat':4 'rat':5

-- 实际应用：选择性字段搜索
CREATE OR REPLACE FUNCTION search_json_fields(data JSONB, query TEXT)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN jsonb_to_tsvector('english', data, '["string"]') @@ to_tsquery('english', query);
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT id, data->>'title'
FROM json_articles
WHERE search_json_fields(data, 'postgresql');
```

## 总结

PostgreSQL 的文本搜索功能提供了：

- **核心运算符**: `@@` 匹配运算符、`&&`、`||`、`!!` 查询组合运算符
- **转换函数**: `to_tsvector`、`to_tsquery`、`plainto_tsquery`、`websearch_to_tsquery`
- **排名函数**: `ts_rank`、`ts_rank_cd` 用于结果排序
- **高亮函数**: `ts_headline` 用于搜索结果高亮显示
- **高级功能**: 权重处理、查询重写、JSON 搜索等

通过合理使用这些功能，可以构建强大的全文搜索系统，支持复杂的搜索需求和高性能的文本检索。

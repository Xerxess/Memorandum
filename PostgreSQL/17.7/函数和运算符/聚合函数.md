# 聚合函数

<https://www.postgresql.org/docs/17/functions-aggregate.html>

## 基础统计函数

- COUNT(*) - 计算行数（包括 NULL） SELECT COUNT(*) FROM users;
- COUNT(col) - 计算指定列非空值的行数 SELECT COUNT(phone) FROM users;
- SUM(col) - 求和 SELECT SUM(amount) FROM orders;
- AVG(col) - 计算平均值 SELECT AVG(score) FROM exams;
- MAX(col) / MIN(col) - 最大值 / 最小值 SELECT MAX(price), MIN(price) FROM products;

## 通用聚合函数

```sql
-- 将所有输入值（包括空值）收集到一个数组中。
-- array_agg ( anynonarray ORDER BY input_sort_columns ) → anyarray

-- 获取每个部门按入职时间排序的员工名单
SELECT dept_id, ARRAY_AGG(name ORDER BY hire_date) 
FROM employees GROUP BY dept_id;

-- demo 
SELECT 
    order_id,
    -- 使用 array_agg 将多行的商品名聚合成一个数组
    -- 并在内部使用 ORDER BY 让数组内的元素按价格降序排列
    ARRAY_AGG(product_name ORDER BY price DESC) AS product_list,
    -- 统计该订单的商品总数
    cardinality(array_agg(product_name)) AS item_count
FROM (
    VALUES 
        (101, 'iPhone 16', 7999),
        (101, '手机壳', 59),
        (101, '充电头', 149),
        (102, 'MacBook Pro', 12999),
        (102, '鼠标', 299)
) AS t(order_id, product_name, price)
GROUP BY order_id;
```

```sql
-- 将所有输入值（包括空值）收集到一个 JSON 数组中。值根据 to_json 或 to_jsonb 转换为 JSON 格式。
-- json_agg ( anyelement ORDER BY input_sort_columns ) → json
-- jsonb_agg ( anyelement ORDER BY input_sort_columns ) → jsonb

-- demo 
SELECT 
    order_id,
    -- 使用 array_agg 将多行的商品名聚合成一个数组
    -- 并在内部使用 ORDER BY 让数组内的元素按价格降序排列
    JSON_AGG(product_name ORDER BY price DESC) AS product_list,
    -- 统计该订单的商品总数
    cardinality(array_agg(product_name)) AS item_count
FROM (
    VALUES 
        (101, 'iPhone 16', 7999),
        (101, '手机壳', 59),
        (101, '充电头', 149),
        (102, 'MacBook Pro', 12999),
        (102, '鼠标', 299)
) AS t(order_id, product_name, price)
GROUP BY order_id;
```
